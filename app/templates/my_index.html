{% extends "appbuilder/base.html" %}

{% block head_js %}
  {{ super() }}
  <script src="{{url_for('static', filename='js/zip.min.js')}}"></script>
  <script src="{{url_for('static', filename='js/submission_check.js')}}"></script>
{% endblock %}

{% block content %}
<div class="jumbotron">
  <div class="container">
    <h1>{{_("SoccerSim Checker")}}</h1>
    <p>Welcome to a platform which allows you to check (and test) the SoccerSim submissions!</p>
    <hr />
    {% if current_user.is_authenticated %}
    <p>
      Please submit your code via the
      <a href="{{ url_for('UploadModelView.list') }}"> Code submission </a>
      interface.
    </p>
    {% else %}
    <p> To upload your submission, please Login first (in the top-right conrner).</p>
    {% endif %}
  </div>
</div>

<div>
  <form action="#">
    <label for="zipinput">Choose ZIP file</label>
    <input type="file" id="zipinput" name="zipinput" accept=".zip">
  </form>

<div id="zip-success" style="color: green;"></div>
<div id="zip-error" style="color: red;"></div>
</div>
{% endblock %}

{% block tail_js %}
    {{ super() }}
    <script>
      function init() {
        var fileInput = document.getElementById("zipinput");
        fileInput.addEventListener("change", function(event) {
            const reader = new zip.ZipReader(new zip.BlobReader(fileInput.files[0]));

            var zip_error = document.getElementById("zip-error");
            var zip_success = document.getElementById("zip-success");
            zip_error.innerHTML = "";
            zip_success.innerHTML = "";

            reader.getEntries().then(function(entries) {
                var errors = get_submission_errors(reader.reader.size, entries);

                if (errors.length > 0) {
                    var error_msg = "<ul>";
                    for (var i = 0; i < errors.length; i++) {
                        error_msg += "<li>" + errors[i] + "</li>";
                    }
                    error_msg += "</ul>";
                    zip_error.innerHTML = error_msg;
                } else {
                   zip_success.innerHTML = "Your ZIP file looks OK!"
                }
            }).catch(function(e) {
                zip_error.innerHTML = "Failed to load your submission. Check whether it is correct ZIP file!";
            });
        });
      }

      window.addEventListener("load", init, false);

    </script>
{% endblock %}
